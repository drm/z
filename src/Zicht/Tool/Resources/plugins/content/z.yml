# Content options
content:
    # Dirs that contain user content (i.e. uploaded files and such)
    dir:            [ 'web/media' ]

    db:
        structure:  ''
        full:       ''

tasks:
    # Backup remote content into a content archive containing all files from the $(content.dirs) variable
    # and a dump of the database
    content.backup:
        set:
            _backup.file: sprintf("content-%s-%s.tar.gz", env, now)
            _backup.cmd: |
                eval("
                    cd $(env.root);
                    mysqldump -Q --opt -d $(env.db)  $(content.db.structure) > db.sql;
                    mysqldump -Q --opt $(env.db) $(content.db.full) >> db.sql;
                    tar zcvf $(_backup.file) $(content.dir) db.sql;
                    rm db.sql
                ")
        do:
            - ssh $(env.ssh) "$(_backup.cmd)"
            - rsync --progress $(env.ssh):$(env.root)$(_backup.file) ./$(_backup.file)

        yield: _backup.file

    # Pull a content archive into the local installation
    content.pull:
        set:
            file: tasks.content.backup
        do:
            - @content.load
            - rm $(file)

    # Pull a content archive into the local installation
    content.push:
        set:
            file: ?
        do:
            - scp $(file) $(env.ssh):$(env.root)/$(file)
            - ssh $(env.ssh) "cd $(env.root); tar zxvf $(file); mysql $(env.db) < ./db.sql; rm $(file); rm db.sql;"

    # Load a content archive
    content.load:
        set:
            file: ?
        do: |
            cd $(env.local.root);
            tar zxvf $(file);
            mysql $(env.local.db) < db.sql
            rm db.sql
