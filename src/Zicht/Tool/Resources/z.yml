vcs:
    url:            ~
    version:        trunk@HEAD

sync:
    options:        "-rupv --size-only --delete"
    exclude_file:   "rsync.exclude"

build:
    dir:            ./build

content:
    dir:            [ 'web/media' ]

env: ~

tasks:
    _clean:         rm -rf $(build.dir)

    _export:
        do:         svn export $(vcs.url)/$(vcs.version) $(build.dir)
        yield:      build.dir

    _sync:          rsync --exclude-from=$(tasks.build)/$(sync.exclude_file) $(sync.options) $(tasks.build)/ $(env.ssh):$(env.root)
    _sync.simulate: rsync --exclude-from=$(tasks.build)/$(sync.exclude_file) $(sync.options) $(tasks.build)/ $(env.ssh):$(env.root) --dry-run

    build:
        pre: [ @_clean, @_export ]
        do:
            - if [ -d "vendor/" ]; then rsync -rp vendor/ $(build.dir)/vendor; fi;
            - if [ -f "$(build.dir)/composer.lock" ]; then cd $(build.dir) && composer install --no-scripts; fi;
            - cd $(build.dir) && make sass;
            - cd $(build.dir) && php app/console assetic:dump --env=$(env) --no-debug;
        yield: build.dir

    deploy:
        pre: @_sync
        do:
            - ssh $(env.ssh) "cd $(env.root) && php app/console cache:clear --env=$(env) --no-debug"

    simulate: @_sync.simulate

    ssh:
        do: ssh -t $(env.ssh)

    ssh.init:
        do: ssh-copy-id $(env.ssh)

    mysql:
        do: ssh -t $(env.ssh) "mysql $(env.db)"

    content.backup:
        set:
            _backup.file:   $(env).$(now).tar.gz
            _backup.cmd:    |
                cd $(env.root);
                mysqldump -Q --opt $(env.db) > db.sql;
                tar zcvf $(_backup.file) $(content.dir) db.sql;
                rm db.sql
        do:
            - ssh $(env.ssh) "$(_backup.cmd)"
            - rsync --progress $(env.ssh):$(env.root)$(_backup.file) ./$(_backup.file)

        yield: _backup.file

#
#    static function uses() {
#        return array(
#            'backup.input',
#            'environment'
#        );
#    }
#
#
#    function execute()
#    {
#        $this->context->execScript('rsync --progress $(backup.input) $(ssh):$(root)$(backup.input)');
#        $this->context->execScript('ssh $(ssh) "cd $(root) && tar zxvf $(backup.input)"');
#        $this->context->execScript('ssh $(ssh) "mysql $(db) < db.sql"');
#    }
#
#
#    function simulate()
#    {
#        $this->context->writeln('rsync --progress $(backup.input) $(ssh):$(root)$(backup.input)');
#        $this->context->writeln('ssh $(ssh) "cd $(root) && tar zxvf $(backup.input)"');
#        $this->context->writeln('ssh $(ssh) "mysql $(db) < db.sql"');
#    }
#
#
#    function getRemoteCommand()
#    {
#        return 'cd $(root); mysqldump -Q --opt $(db) > db.sql; tar zcvf $(backup.input) $(content.dir) db.sql; rm db.sql';
#    }
#}